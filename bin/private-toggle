#!/bin/bash
# depends: awk fusermount gocryptfs notify-send (pinentry-askpass)
set -eu

list-mounted() {
  awk '{if ($3 == "fuse.gocryptfs") print $2}' /etc/mtab
}
send() {
  local cmd=echo
  if [[ -v DISPLAY ]]; then
    if command -v notify-send >/dev/null; then
      cmd=notify-send
    fi
  fi
  $cmd "$@"
}
open() {
  local gocryptfs=(gocryptfs)
  if command -v pinentry-askpass >/dev/null; then
    export PINENTRY_ASKPASS_PROMPT='Decrypting master key'
    export PINENTRY_ASKPASS_DESC="[gocryptfs] password for '$cipherdir':"
    export PINENTRY_ASKPASS_OK=Mount
    export PINENTRY_ASKPASS_ASK=GETPIN
    gocryptfs+=(-extpass pinentry-askpass)
  fi
  "${gocryptfs[@]}" "$cipherdir" "$mountpoint"
}
close() {
  fusermount -u "$mountpoint"
  send "Successfully unmounted: $mountpoint"
}

cipherdir=$HOME/Dropbox/Private
mountpoint=$HOME/Private
if list-mounted | grep -Fqx "$mountpoint"; then
  close
else
  open
fi
