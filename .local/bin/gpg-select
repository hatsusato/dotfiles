#!/bin/bash

set -eu
source "${BASH_SOURCE%/*}"/function/error.sh
source "${BASH_SOURCE%/*}"/function/gpg-colon

usage() {
  cat <<EOF >&2
USAGE: ${0##*/} [-v]
    select gpg key ID interactively

    -v  verbose mode
EOF
  exit 1
}
prompt() {
  local var
  select var in "${comment[@]}"; do
    if [[ -n $var ]]; then
      var=$(($REPLY - 1))
      key=${keyid[$var]}
      return
    fi
  done
  exit 1
}
init-comment() {
  local var
  for var; do
    var=$(gpg-colon --list-keys $var uid:10)
    comment+=("$var")
  done
}
parse-opts() {
  local var
  while getopts v var; do
    case $var in
      v) verbose=on;;
      \?) usage;;
    esac
  done
  return $((OPTIND - 1))
}
main() {
  local -a keyid comment
  local verbose= key
  [[ -t 0 ]] || error 'illegal input from stdin'
  parse-opts "$@" || shift $?
  keyid=($(gpg-colon --list-keys pub:5))
  init-comment ${keyid[@]}
  prompt
  [[ -n $verbose ]] && gpg --list-keys $key >&2
  gpg-colon --list-keys $key fpr:10 | grep -e $key$
}

main "$@"
