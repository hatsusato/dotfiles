#!/bin/bash

set -eu
source "${BASH_SOURCE%/*}"/function/error.sh

usage() {
  cat <<EOF >&2
USAGE: ${0##*/} [-v]
    select gpg key ID interactively

    -v  verbose mode
EOF
  exit 1
}
gpg-list-colon() {
  gpg --list-keys --with-colon "$@"
}
gpg-parse() {
  awk -F: "match(\$1, /^$1\$/) {print \$$2}"
}
prompt() {
  local var
  select var in "${comment[@]}"; do
    if [[ -n $var ]]; then
      var=$(($REPLY - 1))
      key=${keyid[$var]}
      return
    fi
  done
  exit 1
}
init-comment() {
  local var
  for var; do
    var=$(gpg-list-colon $var | gpg-parse uid 10)
    comment+=("$var")
  done
}
parse-opts() {
  local var
  while getopts v var; do
    case $var in
      v) verbose=on;;
      \?) usage;;
    esac
  done
  return $((OPTIND - 1))
}
main() {
  local -a keyid comment
  local verbose= key
  [[ -t 0 ]] || error 'illegal input from stdin'
  parse-opts "$@" || shift $?
  keyid=($(gpg-list-colon | gpg-parse pub 5))
  init-comment ${keyid[@]}
  prompt
  [[ -n $verbose ]] && gpg --list-keys $key >&2
  gpg-list-colon $key | gpg-parse fpr 10 | grep -e $key$
}

main "$@"
