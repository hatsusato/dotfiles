#!/bin/bash

set -eu

sudo-apt() {
  sudo-askpass apt-get "$@"
}
show-dpkg() {
  dpkg --no-pager -l "$@" 2>/dev/null | tail -n+6
}
is-installed() {
  local pkg
  local -i count=0
  for pkg; do
    show-dpkg "$pkg" | grep -q ^ii || count+=1
  done
  return $count
}
prepare() {
  mkdir -p "${log%/*}"
  touch "$log"
}
append() {
  local pkg log=$HOME/.config/local/.install
  [[ -f $log ]] || prepare
  for pkg; do
    grep -xq "$pkg" "$log" &>/dev/null && continue
    tee -a "$log" <<<"$pkg" >/dev/null
  done
}
has-option() {
  local opt
  for opt; do
    [[ $opt == -* ]] && return
  done
  return 1
}
main() {
  if [[ ${1-} != install ]] || has-option "$@"; then
    sudo-apt "$@"
  else
    shift
    is-installed "$@" && exit
    sudo-apt install ${APT_OPTION-} "$@"
    append "$@"
  fi
}

main "$@"
