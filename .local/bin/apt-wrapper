#!/bin/bash

set -eu
source "${BASH_SOURCE%/*}"/function/error
source "${BASH_SOURCE%/*}"/function/apt-register

has-option() {
  local arg
  for arg; do
    [[ $arg == -* ]] && return
  done
  return 1
}
extract-pkg() {
  [[ $pkg == *.deb ]] || return 0
  pkg=$(dpkg -I "$pkg" | awk '$1 == "Package:" {print $2}')
}
show-dpkg() {
  dpkg -l "$pkg" 2>/dev/null | tail -n+6
}
is-installed() {
  local pkg
  for pkg; do
    extract-pkg
    show-dpkg | grep -q ^ii || return 0
  done
  exit
}
set-sudo() {
  if command -v sudo-askpass >/dev/null; then
    sudo=sudo-askpass
  else
    sudo=sudo
  fi
}
main() {
  local sudo=
  if [[ ${1-} == --sudo ]]; then
    shift
    set-sudo
  fi
  if [[ ${1-} == install ]] && ! has-option "$@"; then
    shift
    is-installed "$@"
    $sudo apt install "$@" || exit
    apt-register "$@"
  else
    $sudo apt "$@"
  fi
}

main "$@"
