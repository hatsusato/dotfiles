#!/bin/bash

set -eu
source "${BASH_SOURCE%/*}"/function/error.sh

show-dpkg() {
  dpkg -l "$@" 2>/dev/null | tail -n+6
}
is-installed() {
  local pkg
  for pkg; do
    show-dpkg "$pkg" | grep -q ^ii || return
  done
}
append() {
  local pkg log=$HOME/.config/local/.install
  [[ -f $log ]] || error file not found: "$log"
  for pkg; do
    grep -xq -e "$pkg" "$log" &>/dev/null && continue
    tee -a "$log" <<<"$pkg" >/dev/null
  done
}
has-option() {
  local arg
  for arg; do
    [[ $arg == -* ]] && return
  done
  return 1
}
apt-install() {
  [[ ${1-} == install ]] || return 0
  has-option "$@" && return
  shift
  is-installed "$@" && exit
  if $sudo apt install "$@"; then
    append "$@"
    exit
  else
    exit
  fi
}
set-sudo() {
  if command -v sudo-askpass >/dev/null; then
    sudo=sudo-askpass
  else
    sudo=sudo
  fi
}
main() {
  local sudo=
  if [[ ${1-} == --sudo ]]; then
    shift
    set-sudo
  fi
  apt-install "$@"
  $sudo apt "$@"
}

main "$@"
