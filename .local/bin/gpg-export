#!/bin/bash

set -eu

usage() {
  cat <<EOF >&2
USAGE: ${0##*/} [-s] OUTPUT
    export gpg private keys filtered by paperkey to OUTPUT

    -s  export only subkeys
EOF
  exit 1
}
export-keys() {
  gpg --export-secret-$suffix $id | paperkey --output-width 60
  gpg --armor --export $id
}
parse-opts() {
  local var
  while getopts s var; do
    case $var in
      s) suffix=subkeys;;
      \?) usage;;
    esac
  done
  return $((OPTIND - 1))
}
main() {
  local suffix=keys id
  parse-opts "$@" || shift $?
  (($# > 1)) && usage
  id=$(gpg-select) || exit
  umask 0377
  if [[ ${1--} == - ]]; then
    export-keys
  else
    export-keys >"$1"
  fi
}

main "$@"
