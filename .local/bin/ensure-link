#!/bin/bash

set -eu
source "${BASH_SOURCE%/*}"/function/parse-opts

usage() {
  cat <<EOF >&2
USAGE: ${0##*/} [-v] SRC DST
    link from SRC to DST

    -v  verbose mode
EOF
  exit 1
}
verify() {
  local realsrc=$src realdst=$dst
  if command -v readlink >/dev/null; then
    realsrc=$(readlink -f "$src")
    realdst=$(readlink -f "$dst")
  fi
  [[ -h $src && $realsrc == $realdst ]] || return 0
  exit
}
backup() {
  [[ -r $src ]] || return 0
  cp -abfT$verbose "$src" "$src"
}
main() {
  local verbose= src dst
  local -A opts=([v]=verbose=v [\?]=usage)
  parse-opts "$@" || shift $?
  (($# == 2)) || usage
  src=$1
  dst=$2
  verify
  backup
  ln -sf$verbose "$dst" "$src"
}

main "$@"
