#!/bin/bash

set -eu

usage() {
  cat <<EOF >&2
USAGE: ${0##*/} [-v] SRC DST
    link from SRC to DST

    -v  verbose mode
EOF
  exit 1
}
parse-opts() {
  local var
  while getopts v var; do
    case $var in
      v) verbose=v;;
      \?) usage;;
    esac
  done
  return $((OPTIND - 1))
}
main() {
  local verbose= src dst realpath=echo
  local -a backup
  parse-opts "$@" || shift $?
  (($# == 2)) || usage
  src=$1
  dst=$(realpath "$2")
  backup=(cp -abfT$verbose "$src" "$src")
  command -v realpath >/dev/null && realpath=realpath
  [[ -h $src && $($realpath "$src") == $dst ]] && exit
  [[ -h $src || -r $src ]] && "${backup[@]}"
  ln -sf$verbose "$dst" "$src"
}

main "$@"
