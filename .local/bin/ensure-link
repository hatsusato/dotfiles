#!/bin/bash

set -eu

usage() {
  cat <<EOF >&2
USAGE: ${0##*/} [-v] SRC DST
    link from SRC to DST

    -v  verbose mode
EOF
  exit 1
}
parse-opts() {
  local var
  while getopts v var; do
    case $var in
      v) verbose=v;;
      \?) usage;;
    esac
  done
  return $((OPTIND - 1))
}
main() {
  local verbose= src dst
  parse-opts "$@" || shift $?
  (($# == 2)) || usage
  src=$1
  dst=$2
  if [[ -h $src ]]; then
    [[ $(realpath "$src") == $dst ]] && return
    rm -f "$src"
  elif [[ -e $src ]]; then
    cp -abfT$verbose "$src" "$src".bak
    rm -fr "$src"
  fi
  ln -sf$verbose "$dst" "$src"
}

main "$@"
