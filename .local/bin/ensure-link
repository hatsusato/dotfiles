#!/bin/bash

set -eu

usage() {
  cat <<EOF >&2
USAGE: ${0##*/} [-v] SRC DST
    link from SRC to DST

    -v  verbose mode
EOF
  exit 1
}
parse-opts() {
  local var
  while getopts v var; do
    case $var in
      v) verbose=v;;
      \?) usage;;
    esac
  done
  return $((OPTIND - 1))
}
verify() {
  local realsrc=$src realdst=$dst
  if command -v readlink >/dev/null; then
    realsrc=$(readlink -f "$src")
    realdst=$(readlink -f "$dst")
  fi
  [[ -h $src && $realsrc == $realdst ]] || return 0
  exit
}
backup() {
  [[ -r $src ]] || return 0
  cp -abfT$verbose "$src" "$src"
}
main() {
  local verbose= src dst
  parse-opts "$@" || shift $?
  (($# == 2)) || usage
  src=$1
  dst=$2
  verify
  backup
  ln -sf$verbose "$dst" "$src"
}

main "$@"
