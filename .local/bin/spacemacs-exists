#!/bin/bash

set -eu
source "${BASH_SOURCE%/*}"/function/error

usage() {
  cat <<EOF >&2
USAGE: ${0##*/} [-v] [-w]
    check whether spacemacs daemon is running

    -v  verbose mode
    -w  wait until daemon start up
EOF
  exit 1
}
check() {
  case $? in
    1) return 1;;
    124) error spacemacs hung up;;
    *) error unknown error: $?;;
  esac
}
try() {
  timeout 1s emacsclient -a false -e t &>/dev/null || check
}
wait-for() {
  until try; do
    sleep 0.1s
  done
}
parse-opts() {
  local var
  while getopts vw var; do
    case $var in
      v) verbose=on;;
      w) wait=on;;
      \?) usage;;
    esac
  done
  return $((OPTIND - 1))
}
main() {
  local verbose= wait=
  parse-opts "$@" || shift $?
  [[ -n $wait ]] && wait-for
  try
  [[ -n $verbose ]] && pgrep -af '^spacemacs '
  return 0
}

main "$@"
