#!/bin/bash

set -eu
source "${BASH_SOURCE%/*}"/function/error.sh

is-mounted() {
  local -a opts=("${args[@]}" fuse.gocryptfs)
  awk '{print $1,$2,$3}' /etc/mtab | grep -Fqx "${opts[*]}"
}
private-exists() {
  [[ -d $1 ]] || error directory not found: "$1"
}
private-mount() {
  local -a cmd=(gocryptfs)
  if command -v pinentry-askpass >/dev/null; then
    cmd+=(-extpass pinentry-askpass)
  fi
  "${cmd[@]}" "${args[@]}"
}
private-umount() {
  fusermount -u "$mountpoint"
}
main() {
  local cipherdir mountpoint suffix=mount
  local -a args
  cipherdir=$HOME/Dropbox/Private
  mountpoint=$HOME/Private
  args=("$cipherdir" "$mountpoint")
  private-exists "$cipherdir"
  private-exists "$mountpoint"
  is-mounted && suffix=umount
  private-$suffix
}

main
