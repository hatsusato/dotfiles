#!/bin/bash

set -eu
source "${BASH_SOURCE%/*}"/function/parse-opts

usage() {
  cat <<EOF >&2
USAGE: ${0##*/} [-c] [-x] FILE...
    initialize FILEs with include guard

    -c  force C mode
    -x  force C++ mode
EOF
  exit 1
}
set-guard() {
  guard=$(uuidgen -r | tr '[:lower:]-' '[:upper:]_')
  guard=INCLUDE_GUARD_$guard
}
set-comment() {
  local style=x
  [[ ${header-} == *.h ]] && style=c
  case ${mode-$style} in
    c) comment="/* $guard */";;
    x) comment="// $guard";;
  esac
}
generate() {
  local guard comment
  set-guard
  set-comment
  cat <<EOF
#ifndef $guard
#define $guard
#endif $comment
EOF
}
main() {
  local mode header
  local -A opts=([c]=mode=c [x]=mode=x [\?]=usage)
  parse-opts "$@" || shift $?
  for header; do
    if [[ -s $header ]]; then
      touch "$header"
    else
      generate | tee "$header"
    fi
  done
  [[ -n ${header+set} ]] || generate
}

main "$@"
